/* backbone-nestify 0.3.0 2014-01-28
 * http://revelytix.github.io/backbone-nestify/
 * Copyright 2013 Revelytix, Inc. All rights reserved. */
!function(a){"object"==typeof module?module.exports=a(require("underscore"),require("backbone")):"function"==typeof define&&define.amd?define(["underscore","backbone"],a):this.nestify=a(this._,this.Backbone)}(function(a,b){var c=function(a){return null!=a},d={coll:"at",delim:"|"},e=function(c,d){return a.reduce(c,function(c,d){var e;return c&&(e=a.isNumber(d)?c instanceof b.Collection?c.at(d):c[d]:c instanceof b.Model?c.attributes[d]:c[d]),e},d)},f=function(b){return a.map(b,function(b){var c=parseInt(b,10);return a.isNaN(c)?b:c})},g=function(b,c){var d=c.delim;return a.isString(b)&&b.indexOf(d)>-1?f(b.split(d)):b},h=function(b,c){var d;return a.isObject(b)&&!a.isArray(b)?d=b:(a.isArray(b)||a.isString(b))&&(b=a.isArray(b)?b:[b],d=a.reduceRight(b,function(b,c){var d;return d=a.isNumber(c)?[]:{},d[c]=b,d},c)),d},i=function(b){a.isArray(b)||console.log("**WARNING**! expected array but found: "+JSON.stringify(b))},j={stringMatcher:function(a,b){return a===b},regexMatcher:function(a,b){return a.test(b)},matchAll:function(){return!0},useUnmodified:function(a,b,d,e){return this.isModel(a,b)||this.isCollection(a,b)||e.unset&&!c(b)},isModel:function(a,c){return c instanceof b.Model},isExistingModel:function(a,c,d){return d instanceof b.Model},isCollection:function(a,c){return c instanceof b.Collection},isExistingCollection:function(a,c,d){return d instanceof b.Collection},isArray:function(b,c){return a.isArray(c)},isExistingArray:function(b,c,d){return a.isArray(d)},isObject:function(b,c){return a.isObject(c)},isExistingObject:function(b,c,d){return a.isObject(d)}};a.bindAll(j,"useUnmodified");var k={determineType:function(c){var d;return c instanceof b.Model?d="model":c instanceof b.Collection?d="collection":a.isArray(c)?d="array":a.isObject(c)&&(d="object"),d},findContainerFn:function(b,c,d,e,f){var g=a.find(b,function(a){return a._matcherFn(c,d,e,f)});return g._containerFn},object:{merge:function(b,c){return a.extend({},b,c)},reset:function(a,b){return b}},array:{merge:function(b,c){return a.map(a.zip(c,b),a.compose(a.first,a.compact))},reset:function(a,b){return b}},model:{merge:function(a,b,c){return a.set(b,c),a},reset:function(a,b,c){return a.clear(),a.set(b,c),a}},collection:{reset:function(b,c,d){i(c);var e=b.model;return b.reset(a.map(c,function(a){return new e(a,d)}),d),b},smartMerge:function(b,c,d){i(c);var e=b.model;return b.set(a.map(c,function(a){return new e(a,d)}),d),b},merge:function(b,c,d){i(c);var e=b.model,f=a.zip(b.models,c);return a.each(f,function(c,f){var g=a.first(c),h=a.last(c);h&&(g?g.set(h,d):(g=new e(h,d),b.models[f]=g,b.length=b.models.length))}),b}}},l={defaults:{object:"reset",array:"reset",collection:"merge",model:"merge"},object:{reset:k.object.reset,merge:k.object.merge,smart:k.object.merge},array:{reset:k.array.reset,merge:k.array.merge,smart:k.array.merge},model:{reset:k.model.reset,merge:k.model.merge,smart:k.model.merge},collection:{reset:k.collection.reset,merge:k.collection.merge,smart:k.collection.smartMerge}},m=function(b,c,d){return d=d||{},c=a.reduce(c,function(a,c,e){var f=this.attributes&&this.attributes[e],g=k.findContainerFn(b,e,c,f,d);return a[e]=g(c,f,d,e,this),a},{},this)},n={determineTypeFromConstructor:function(a){var c;return a===b.Model||a.prototype instanceof b.Model?c="model":a===b.Collection||a.prototype instanceof b.Collection?c="collection":a===Array?c="array":a===Object&&(c="object"),c},compileConstructorFn:function(b,d){var e=c(d);return function(c,d,f,g){var h=e?new b.constructor(b.args,d):b.constructor(b.args,d,f,g);return"recurse"===b.spec?a.extend(h,d.compiled):b.spec&&a.extend(h,o(b.spec)),h.set(c,d),h}},compileContainerFn:function(b){b=a.isFunction(b)?{constructor:b}:b;var c=this.determineTypeFromConstructor(b.constructor),d=c&&l[c],e=this.compileConstructorFn(b,c),f=l.defaults[c];return function(a,b,g){if(b){var h=g.update||f;return c=c||k.determineType(a),d=d||l[c],d[h](b,a,g)}return e(a,g)}},compileExistingContainerFn:function(a){var b=l[a],c=l.defaults[a];return function(a,d,e){var f=e.update||c;return b[f](d,a,e)}},compile:function(b,c){var d,e;return d=a.isArray(b)?b:a.isObject(b)?[{hash:b}]:[],e=[{_matcherFn:j.useUnmodified,_containerFn:a.identity}],e=a.reduce(d,function(b,c){if(c.hash)a.each(c.hash,function(c,d){b.push({_matcherFn:a.partial(j.stringMatcher,d),_containerFn:this.compileContainerFn(c)})},this);else{var d={_containerFn:this.compileContainerFn(c.container)};d._matcherFn=a.isRegExp(c.match)?a.partial(j.regexMatcher,c.match):a.isString(c.match)?a.partial(j.stringMatcher,c.match):a.isFunction(c.match)?c.match:j.matchAll,b.push(d)}return b},e,this),e.push({_matcherFn:j.isExistingCollection,_containerFn:this.compileExistingContainerFn("collection")},{_matcherFn:j.isExistingModel,_containerFn:this.compileExistingContainerFn("model")},{_matcherFn:j.isExistingArray,_containerFn:this.compileExistingContainerFn("array")},{_matcherFn:j.isExistingObject,_containerFn:this.compileExistingContainerFn("object")}),e.push({_matcherFn:j.matchAll,_containerFn:a.identity}),c.compiled=e,e}},o=a.extend(function(c,f){var i=a.extend({},d,f);return c=n.compile(c,i),{get:function(c,d){return d=a.extend({},i,d),c=g(c,d),a.isArray(c)?e(c,this):b.Model.prototype.get.apply(this,arguments)},set:function(d,e,f){var j;return!a.isArray(d)&&a.isObject(d)?(f=a.extend({},i,e),j=d instanceof b.Model?d.attributes:d):(f=a.extend({},i,f),d=g(d,f),j=h(d,e)),!a.isObject(j)||f instanceof b.Model||(j=m.call(this,c,j,f)),b.Model.prototype.set.call(this,j,f)}}},{auto:function(c){var d=b.Model.extend(),e=b.Collection.extend({model:d}),f="recurse",g=[{match:j.isArray,container:e},{match:j.isObject,container:{constructor:d,spec:f}}],h=o(g,c);return a.extend(d.prototype,h),h},instance:function(c,d,e){if(c instanceof b.Model){a.extend(c,o(d,e));var f=c.attributes;c.attributes={},c.set(f,e)}return c},pathToObject:h});return o});