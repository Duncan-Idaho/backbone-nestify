/* backbone-nestify 0.2.0 2013-12-19
 * http://revelytix.github.io/backbone-nestify/
 * Copyright 2013 Revelytix, Inc. All rights reserved. */
!function(a){"object"==typeof module?module.exports=a(require("underscore"),require("backbone")):"function"==typeof define&&define.amd?define(["underscore","backbone"],a):this.nestify=a(this._,this.Backbone)}(function(a,b){var c=function(a){return null!=a},d={coll:"at",delim:"|"},e=function(c,d){return a.reduce(c,function(c,d){var e;return c&&(e=a.isNumber(d)?c instanceof b.Collection?c.at(d):c[d]:c instanceof b.Model?c.attributes[d]:c[d]),e},d)},f=function(b){return a.map(b,function(b){var c=parseInt(b,10);return a.isNaN(c)?b:c})},g=function(b,c){var d=c.delim;return a.isString(b)&&b.indexOf(d)>-1?f(b.split(d)):b},h=function(b,c){var d;return a.isObject(b)&&!a.isArray(b)?d=b:(a.isArray(b)||a.isString(b))&&(b=a.isArray(b)?b:[b],d=a.reduceRight(b,function(b,c){var d;return d=a.isNumber(c)?[]:{},d[c]=b,d},c)),d},i=function(b){a.isArray(b)||console.log("**WARNING**! expected array but found: "+JSON.stringify(b))},j={reset:function(b,c,d){i(c);var e=b.model;b.reset(a.map(c,function(a){return new e(a,d)}),d)},set:function(b,c,d){i(c);var e=b.model;b.set(a.map(c,function(a){return new e(a,d)}),d)},setAt:function(b,c,d){i(c);var e=b.model,f=a.zip(b.models,c);a.each(f,function(c,f){var g=a.first(c),h=a.last(c);h&&(g?g.set(h,d):(g=new e(h,d),b.models[f]=g,b.length=b.models.length))})}},k={stringMatcher:function(a,b){return a===b},regexMatcher:function(a,b){return a.test(b)},matchAll:function(){return!0},useUnmodified:function(a,d,e,f){return d instanceof b.Model||d instanceof b.Collection||f.unset&&!c(d)},isModel:function(){},isCollection:function(){},isArray:function(b,c){return a.isArray(c)},isObject:function(b,c){return a.isObject(c)}},l={findContainerFn:function(b,c,d,e,f){var g=a.find(b,function(a){return a._matcherFn(c,d,e,f)});return g?g._containerFn:a.bind(this.notSpecked,this)},makeContainerFn:function(b){var c;return a.isFunction(b.fn)?c=b.fn:(b=a.isFunction(b)?{constructor:b}:b,c=a.partial(this.specked,function(c){var d=new b.constructor(b.args);return"recurse"===b.spec?a.extend(d,c.compiled):b.spec&&a.extend(d,o(b.spec)),d})),c},specked:function(a,b,c,d){var e=c||a(d);if(e.reset)if(c)switch(d.coll){case"reset":j.reset(e,b,d);break;case"set":j.set(e,b,d);break;case"at":default:j.setAt(e,b,d)}else j.reset(e,b,d);else e.set(b,d);return e},notSpecked:function(b,c){var d=b;return c&&(a.isArray(c)?d=this.overlayArray(b,c):a.isObject(c)&&(d=this.overlayObject(b,c))),d},overlayObject:function(b,c){return a.extend({},c,b)},overlayArray:function(b,c){return a.map(a.zip(b,c),a.compose(a.first,a.compact))}},m=function(b,c,d){return d=d||{},c=a.reduce(c,function(a,c,e){var f=this.attributes&&this.attributes[e],g=l.findContainerFn(b,e,c,f,d);return a[e]=g(c,f,d,e,this),a},{},this)},n=function(b,c){var d,e;return d=a.isArray(b)?b:a.isObject(b)?[{hash:b}]:[],e=[{_matcherFn:k.useUnmodified,_containerFn:a.identity}],e=a.reduce(d,function(b,c){if(c.hash)a.each(c.hash,function(c,d){b.push({_matcherFn:a.partial(k.stringMatcher,d),_containerFn:l.makeContainerFn(c)})});else{var d={_containerFn:l.makeContainerFn(c.container)};d._matcherFn=a.isRegExp(c.match)?a.partial(k.regexMatcher,c.match):a.isString(c.match)?a.partial(k.stringMatcher,c.match):a.isFunction(c.match)?c.match:k.matchAll,b.push(d)}return b},e),c.compiled=e,e},o=a.extend(function(c,f){var i=a.extend({},d,f),j=a.partial(m,n(c,i));return{get:function(c,d){return d=a.extend({},i,d),c=g(c,d),a.isArray(c)?e(c,this):b.Model.prototype.get.apply(this,arguments)},set:function(c,d,e){var f;return!a.isArray(c)&&a.isObject(c)?(e=a.extend({},i,d),f=c instanceof b.Model?c.attributes:c):(e=a.extend({},i,e),c=g(c,e),f=h(c,d)),!a.isObject(f)||e instanceof b.Model||(f=j.call(this,f,e)),b.Model.prototype.set.call(this,f,e)}}},{auto:function(c){var d=b.Model.extend(),e=b.Collection.extend({model:d}),f="recurse",g=[{match:k.isArray,container:e},{match:k.isObject,container:{constructor:d,spec:f}}],h=o(g,c);return a.extend(d.prototype,h),h},pathToObject:h});return o});